<script>
  /**
   * [SYSTEM] Global Error Handler
   */
  window.onerror = function(msg, url, lineNo, columnNo, error) {
    showError(`Global Error: ${msg}\nLine: ${lineNo}`);
    return false; 
  };

  function showError(msg, isError = true) {
    const consoleEl = document.getElementById('debug-console');
    const logsEl = document.getElementById('debug-logs');
    
    consoleEl.classList.remove('hidden');
    
    const div = document.createElement('div');
    const time = new Date().toLocaleTimeString();
    div.innerText = `[${time}] ${msg}`;
    div.className = isError ? 'text-red-400 border-b border-gray-800 pb-1' : 'text-green-400 border-b border-gray-800 pb-1';
    
    logsEl.prepend(div); 
    console.log(msg); 
  }

  // ==========================================
  
  let cachedMaterials = null; 
  let cachedRawMaterialItems = []; 
  let cachedLotSettings = []; // [NEW] 로트 설정 캐시
  let currentDetailContext = { item: null, rawHistory: [], selectedLot: 'ALL' };
  let currentSettingsFilter = '사용';

  window.onload = function() {
    try {
      google.script.run
        .withSuccessHandler(initApp)
        .withFailureHandler(err => showError("초기 데이터 로드 실패: " + err.message))
        .getInitialData();
      setInitialDates(); 
    } catch(e) {
      showError("window.onload 에러: " + e.message);
    }
  };

  function setInitialDates() {
      const today = new Date();
      const lastYear = new Date();
      lastYear.setFullYear(today.getFullYear() - 1);
      
      const toDateString = (date) => date.toISOString().split('T')[0];
      const todayStr = toDateString(today);
      const lastYearStr = toDateString(lastYear);

      document.querySelectorAll('input[name="date"]').forEach(el => el.value = todayStr);
      
      const startEl = document.getElementById('main-date-start');
      const endEl = document.getElementById('main-date-end');
      if(startEl && endEl) {
        startEl.value = lastYearStr;
        endEl.value = todayStr;
      }
  }

  function initApp(data) {
    document.getElementById('header-company-name').innerText = data.companyName;
    document.getElementById('setting-email').innerText = data.currentUser;
    
    cachedRawMaterialItems = data.rawMaterials || [];
    cachedLotSettings = data.lotSettings || []; 

    updateMaterialDropdown(); 
    filterSettingsItems(currentSettingsFilter); 
    renderLotSettingsList(); 
  }

  function updateMaterialDropdown() {
    const select = document.getElementById('input-material-item');
    if (!select) return;

    select.innerHTML = '<option value="" disabled selected>선택하세요</option>';
    
    const activeItems = cachedRawMaterialItems.filter(item => item.status === '사용');

    if (activeItems.length === 0) {
        const opt = document.createElement('option');
        opt.disabled = true;
        opt.text = "(설정에서 품목을 먼저 등록해주세요)";
        select.add(opt);
    } else {
        activeItems.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.name;
          opt.text = `${item.name} (${item.unit})`;
          select.add(opt);
        });
    }
  }

  // [설정] 품목 필터링
  function filterSettingsItems(filterType) {
    currentSettingsFilter = filterType;
    
    const btns = {
        'ALL': document.getElementById('filter-btn-all'),
        '사용': document.getElementById('filter-btn-active'),
        '미사용': document.getElementById('filter-btn-inactive')
    };
    
    Object.keys(btns).forEach(key => {
        if(btns[key]) {
            if (key === filterType) {
                btns[key].className = "flex-1 text-xs font-bold py-1.5 rounded-md transition-all bg-white shadow text-gray-800";
            } else {
                btns[key].className = "flex-1 text-xs font-bold py-1.5 rounded-md transition-all text-gray-500 hover:text-gray-800";
            }
        }
    });

    renderSettingsItemList();
  }

  function renderSettingsItemList() {
    const container = document.getElementById('settings-material-list');
    if (!container) return;

    let displayItems = cachedRawMaterialItems;
    if (currentSettingsFilter !== 'ALL') {
        displayItems = cachedRawMaterialItems.filter(item => item.status === currentSettingsFilter);
    }

    if (displayItems.length === 0) {
      container.innerHTML = '<div class="text-center text-gray-400 text-xs py-4 border border-dashed rounded-lg">해당되는 원재료가 없습니다.</div>';
      return;
    }

    let html = '';
    displayItems.forEach((item) => {
      const statusBadge = item.status === '미사용' 
        ? '<span class="text-[10px] text-red-500 bg-red-50 px-1.5 py-0.5 rounded ml-2">미사용</span>' 
        : '<span class="text-[10px] text-green-600 bg-green-50 px-1.5 py-0.5 rounded ml-2">사용</span>';

      html += `
        <div class="flex justify-between items-center bg-gray-50 px-3 py-2 rounded-lg border border-gray-200">
          <div class="flex items-center">
            <span class="text-sm font-bold text-gray-700">${item.name}</span>
            ${statusBadge}
            <span class="text-xs text-gray-400 ml-2">(${item.unit})</span>
          </div>
          <div class="flex space-x-1">
             <button type="button" onclick="openEditItemModal('${item.name}')" class="p-1 text-gray-400 hover:text-blue-600 rounded transition-colors">
               <span class="material-icons text-base">edit</span>
             </button>
             <button type="button" onclick="deleteItem('${item.name}')" class="p-1 text-gray-400 hover:text-red-600 rounded transition-colors">
               <span class="material-icons text-base">delete</span>
             </button>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }
  
  // [NEW] 로트번호 설정 리스트 렌더링
  function renderLotSettingsList() {
    const tbody = document.getElementById('settings-lot-list');
    
    // 안전장치: 화면 요소가 없으면 종료
    if(!tbody) {
        console.warn("settings-lot-list element not found");
        return;
    }

    if(cachedLotSettings.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-xs text-gray-400">설정된 데이터가 없습니다.</td></tr>';
      return;
    }

    let html = '';
    cachedLotSettings.forEach(lot => {
      html += `
        <tr onclick="openLotEditModal('${lot.category}')" class="hover:bg-blue-50 cursor-pointer transition-colors">
          <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-800 border-b border-gray-100 pl-4">${lot.category}</td>
          <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-600 text-center border-b border-gray-100 font-mono bg-gray-50 rounded-lg">${lot.start}</td>
          <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-600 text-center border-b border-gray-100 font-mono">${lot.end}</td>
          <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-400 text-center border-b border-gray-100 font-mono">${lot.last}</td>
        </tr>
      `;
    });
    tbody.innerHTML = html;
  }

  // [NEW] 로트번호 등록 모달 열기
  function openAddLotModal() {
    document.getElementById('form-setting-lot').reset();
    document.getElementById('lot-category-hidden').value = ""; 
    
    document.getElementById('lot-modal-title').innerText = "식별자 범위 등록";
    document.getElementById('lot-category-display').classList.add('hidden');
    document.getElementById('lot-category-input').classList.remove('hidden');
    
    // [UPDATED] 등록 모드에서는 삭제 버튼 숨김
    document.getElementById('btn-delete-lot').classList.add('hidden');

    document.getElementById('btn-save-lot').innerText = "등록하기";
    openModal('modal-setting-lot');
  }

  // [NEW] 로트번호 수정 모달 열기
  function openLotEditModal(category) {
    const lot = cachedLotSettings.find(l => l.category === category);
    if(!lot) return;

    document.getElementById('form-setting-lot').reset();
    document.getElementById('lot-category-hidden').value = lot.category;
    
    document.getElementById('lot-modal-title').innerText = "식별자 범위 수정";
    document.getElementById('lot-category-display').classList.remove('hidden');
    document.getElementById('lot-category-display').innerText = lot.category;
    document.getElementById('lot-category-input').classList.add('hidden');
    
    document.getElementById('lot-start').value = lot.start;
    document.getElementById('lot-end').value = lot.end;

    // [UPDATED] 수정 모드에서는 삭제 버튼 표시
    document.getElementById('btn-delete-lot').classList.remove('hidden');

    document.getElementById('btn-save-lot').innerText = "수정하기";
    openModal('modal-setting-lot');
  }
  
  // [NEW] 로트번호 설정 삭제 요청
  function deleteLotCurrent() {
      const category = document.getElementById('lot-category-hidden').value;
      if(!category) return;
      
      uiConfirm(`'${category}' 식별자 설정을 삭제하시겠습니까?\n\n※ 해당 카테고리로 생성된 기존 데이터에는 영향을 주지 않습니다.`, () => {
          google.script.run
            .withSuccessHandler((res) => {
                uiAlert(res, "삭제 완료", "check_circle");
                closeModal('modal-setting-lot');
                
                cachedLotSettings = cachedLotSettings.filter(l => l.category !== category);
                renderLotSettingsList();
            })
            .withFailureHandler(err => {
                const cleanMsg = err.message.replace(/^Error:\s*/i, '').replace(/^Exception:\s*/i, '').trim();
                uiAlert(cleanMsg, "삭제 실패", "warning");
            })
            .deleteLotConfig(category);
      }, "식별자 삭제");
  }

  // [NEW] 로트번호 수정/등록 제출
  function submitLotSetting(e) {
    e.preventDefault();
    const btn = document.getElementById('btn-save-lot');
    const originalText = btn.innerText;
    
    // 유효성 검사 (클라이언트)
    const startVal = parseInt(document.getElementById('lot-start').value);
    const endVal = parseInt(document.getElementById('lot-end').value);
    
    if(startVal >= endVal) {
        uiAlert("종료 번호는 시작 번호보다 커야 합니다.", "입력 오류", "warning");
        return;
    }

    btn.disabled = true;
    btn.innerText = '저장 중...';

    const form = e.target;
    const formData = {};
    new FormData(form).forEach((value, key) => formData[key] = value);

    // Determine Mode based on hidden input
    // If hidden input has value, it's Edit Mode. If empty, it's Add Mode.
    const isEditMode = !!formData.lotCategory;
    const serverFunc = isEditMode ? 'updateLotConfig' : 'addLotConfig';

    google.script.run
      .withSuccessHandler((res) => {
          uiAlert(res, "완료", "check_circle");
          closeModal('modal-setting-lot');
          
          // 로컬 캐시 업데이트
          if (isEditMode) {
              const idx = cachedLotSettings.findIndex(l => l.category === formData.lotCategory);
              if(idx !== -1) {
                 cachedLotSettings[idx].start = parseInt(formData.lotStart);
                 cachedLotSettings[idx].end = parseInt(formData.lotEnd);
              }
          } else {
              // Add new item to cache
              cachedLotSettings.push({
                  category: formData.lotCategoryInput,
                  start: parseInt(formData.lotStart),
                  end: parseInt(formData.lotEnd),
                  last: parseInt(formData.lotStart) - 1
              });
          }
          renderLotSettingsList();
          
          btn.disabled = false;
          btn.innerText = originalText;
      })
      .withFailureHandler(err => {
          const cleanMsg = err.message.replace(/^Error:\s*/i, '').replace(/^Exception:\s*/i, '').trim();
          uiAlert(cleanMsg, "저장 실패", "error_outline");
          btn.disabled = false;
          btn.innerText = originalText;
      })
      [serverFunc](formData);
  }

  function openSettingItemModal() {
    document.getElementById('form-setting-item').reset();
    document.getElementById('item-original-name').value = ""; 
    document.getElementById('item-modal-title').innerText = "원재료 품목 등록";
    document.getElementById('btn-save-item').innerText = "등록하기";
    document.getElementById('item-status').value = "사용"; 
    document.getElementById('item-edit-warning').classList.add('hidden'); 
    
    openModal('modal-setting-item');
  }
  
  function openEditItemModal(name) {
    const item = cachedRawMaterialItems.find(i => i.name === name);
    if(!item) return;

    document.getElementById('form-setting-item').reset();
    document.getElementById('item-original-name').value = item.name; 
    
    document.getElementById('item-name').value = item.name;
    document.getElementById('item-unit').value = item.unit;
    document.getElementById('item-status').value = item.status;

    document.getElementById('item-modal-title').innerText = "원재료 품목 수정";
    document.getElementById('btn-save-item').innerText = "수정하기";
    document.getElementById('item-edit-warning').classList.remove('hidden'); 

    openModal('modal-setting-item');
  }

  // [UPDATED] 품목 삭제 요청 
  function deleteItem(name) {
    uiConfirm(`'${name}' 품목을 삭제하시겠습니까?\n\n※ 사용 이력이 있는 경우 삭제되지 않습니다.`, () => {
        google.script.run
        .withSuccessHandler((res) => {
            uiAlert(res, "삭제 완료", "check_circle");
            cachedRawMaterialItems = cachedRawMaterialItems.filter(i => i.name !== name);
            updateMaterialDropdown();
            filterSettingsItems(currentSettingsFilter);
        })
        .withFailureHandler(err => {
            // [수정] "Error: " 접두어 제거 및 깔끔한 표시
            const cleanMsg = err.message.replace(/^Error:\s*/i, '').replace(/^Exception:\s*/i, '').trim();
            uiAlert(cleanMsg, "삭제 불가", "warning"); 
        })
        .deleteItem(name);
    }, "품목 삭제");
  }

  // [UPDATED] 품목 등록/수정 요청
  function submitItem(e) {
    e.preventDefault(); 
    try {
        const btn = document.getElementById('btn-save-item');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = '처리 중...';

        const form = e.target;
        const formData = {};
        new FormData(form).forEach((value, key) => formData[key] = value);

        const serverFunc = formData.originalItemName ? 'editItem' : 'addItem';

        google.script.run
        .withSuccessHandler((res) => {
            uiAlert(res, "완료", "check_circle");
            form.reset();
            closeModal('modal-setting-item');
            
            if (formData.originalItemName) {
                const idx = cachedRawMaterialItems.findIndex(i => i.name === formData.originalItemName);
                if(idx !== -1) {
                    cachedRawMaterialItems[idx] = { 
                        name: formData.itemName, 
                        unit: formData.unit, 
                        status: formData.status 
                    };
                }
                if(formData.originalItemName !== formData.itemName) loadMaterials(); 
            } else {
                cachedRawMaterialItems.push({ 
                    name: formData.itemName, 
                    unit: formData.unit, 
                    status: formData.status || '사용' 
                });
            }
            
            updateMaterialDropdown();
            filterSettingsItems(currentSettingsFilter);
            btn.disabled = false;
            btn.innerText = originalText;
        })
        .withFailureHandler(err => {
            // [수정] 에러 메시지 정리
            const cleanMsg = err.message.replace(/^Error:\s*/i, '').replace(/^Exception:\s*/i, '').trim();
            uiAlert(cleanMsg, "저장 실패", "error_outline");
            btn.disabled = false;
            btn.innerText = originalText;
        })
        [serverFunc](formData);
    } catch(err) {
        showError("submitItem JS 에러: " + err.message);
    }
  }

  // ========================
  // 공통 UI 함수
  // ========================

  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    if (sidebar.classList.contains('sidebar-closed')) {
      sidebar.classList.remove('sidebar-closed');
      sidebar.classList.add('sidebar-open');
      overlay.classList.remove('hidden');
    } else { closeSidebar(); }
  }

  function closeSidebar() {
    document.getElementById('sidebar').classList.remove('sidebar-open');
    document.getElementById('sidebar').classList.add('sidebar-closed');
    document.getElementById('sidebar-overlay').classList.add('hidden');
  }

  function navigateTo(viewId) {
    document.querySelectorAll('.view-section').forEach(view => view.classList.add('hidden'));
    const target = document.getElementById(viewId);
    if (target) {
      target.classList.remove('hidden');
      if (viewId === 'view-materials') loadMaterials();
      if (viewId === 'view-production') loadProduction();
      if (viewId === 'view-settings') filterSettingsItems(currentSettingsFilter);
    }
    closeSidebar();
  }

  function openModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
  function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }

  // ========================
  // 원재료 관련 함수
  // ========================
  
  function openMaterialModal() {
    document.getElementById('form-material').reset();
    document.getElementById('material-rowIndex').value = ""; 
    document.getElementById('material-modal-title').innerText = "원재료 입출고 등록";
    document.getElementById('btn-save-material').innerText = "저장하기";
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('material-date').value = today;
    
    openModal('modal-material');
  }

  function openEditMaterialModal(id) {
    const itemData = cachedMaterials.history.find(h => h.id == id);
    if (!itemData) {
      uiAlert("데이터를 찾을 수 없습니다.");
      return;
    }

    document.getElementById('material-rowIndex').value = itemData.id;
    document.getElementById('material-date').value = itemData.date;
    document.getElementById('input-material-item').value = itemData.item;
    document.getElementById('material-type').value = itemData.type;
    document.getElementById('material-qty').value = Math.abs(itemData.qty);
    document.getElementById('material-lot').value = itemData.lot;
    document.getElementById('material-desc').value = itemData.desc;

    document.getElementById('material-modal-title').innerText = "원재료 내역 수정";
    document.getElementById('btn-save-material').innerText = "수정 완료";
    
    openModal('modal-material');
  }

  function deleteRawMaterial(id) {
    uiConfirm("정말 이 내역을 삭제하시겠습니까?\n삭제 후에는 복구할 수 없습니다.", () => {
        google.script.run
        .withSuccessHandler((res) => {
            uiAlert(res, "삭제 완료", "check_circle");
            closeModal('modal-material-detail'); 
            loadMaterials(); 
        })
        .withFailureHandler(err => {
            const cleanMsg = err.message.replace(/^Error:\s*/i, '').replace(/^Exception:\s*/i, '').trim();
            uiAlert(cleanMsg, "오류", "error");
        })
        .deleteRawMaterial(id);
    }, "내역 삭제");
  }

  function loadMaterials() {
    const listEl = document.getElementById('material-list');
    const summaryEl = document.getElementById('material-summary');
    
    listEl.innerHTML = '<div class="text-center py-10 text-gray-400"><div class="loader mx-auto mb-2"></div><p class="text-xs">내역 로딩 중...</p></div>';
    summaryEl.innerHTML = '<div class="flex-shrink-0 w-full h-20 bg-gray-50 rounded-xl flex items-center justify-center text-gray-400 text-xs border border-dashed"><div class="loader mr-2" style="width:16px;height:16px;"></div>재고 계산 중...</div>';
    
    google.script.run.withSuccessHandler(onMaterialsLoaded)
    .withFailureHandler(err => {
        showError("원재료 로드 실패: " + err.message); // 데이터 로드 실패는 시스템 에러일 확률이 높으므로 남김
        listEl.innerHTML = '<div class="text-red-500 text-center py-4 text-xs">데이터 로드 에러</div>';
        summaryEl.innerHTML = '<div>Error</div>';
    })
    .getMaterials();
  }

  function onMaterialsLoaded(data) {
    cachedMaterials = data;
    updateMainView();
  }

  function updateMainView() {
    if (!cachedMaterials || !cachedMaterials.history) return;

    const startStr = document.getElementById('main-date-start').value;
    const endStr = document.getElementById('main-date-end').value;
    const hideZero = document.getElementById('toggle-main-zero').checked;

    const filteredHistory = cachedMaterials.history.filter(h => {
        return h.date >= startStr && h.date <= endStr;
    });

    const stockMap = {};
    filteredHistory.forEach(item => {
        const qty = item.type === '입고' ? item.qty : -item.qty;
        if(!stockMap[item.item]) stockMap[item.item] = 0;
        stockMap[item.item] += qty;
    });
    
    let computedSummary = Object.keys(stockMap).map(key => ({
      item: key,
      total: stockMap[key]
    }));

    if (hideZero) {
      computedSummary = computedSummary.filter(item => item.total !== 0);
    }
    
    computedSummary.sort((a, b) => a.item.localeCompare(b.item));

    renderMainSummary(computedSummary);
    renderMainList(filteredHistory);
  }

  function renderMainSummary(summaryData) {
    const summaryEl = document.getElementById('material-summary');
    
    if (!summaryData || summaryData.length === 0) {
        summaryEl.innerHTML = '<div class="flex-shrink-0 w-full h-20 bg-gray-50 rounded-xl flex items-center justify-center text-gray-400 text-xs border border-dashed">표시할 데이터가 없습니다.</div>';
        return;
    }

    let summaryHtml = '';
    summaryData.forEach(item => {
      const stockClass = item.total <= 0 ? 'text-red-500 bg-red-50 border-red-100' : 'text-blue-600 bg-blue-50 border-blue-100';
      summaryHtml += `
        <div onclick="openMaterialDetail('${item.item}')" class="flex-shrink-0 w-32 bg-white rounded-xl border p-3 flex flex-col justify-between shadow-sm snap-center cursor-pointer hover:border-orange-300 hover:shadow-md transition-all active:scale-95">
          <span class="text-xs text-gray-500 font-bold truncate">${item.item}</span>
          <div class="text-right">
            <span class="text-lg font-bold ${stockClass} px-2 py-1 rounded-md inline-block">${item.total}</span>
          </div>
        </div>
      `;
    });
    summaryEl.innerHTML = summaryHtml;
  }

  function renderMainList(historyData) {
    const listEl = document.getElementById('material-list');
    
    if (!historyData || historyData.length === 0) {
      listEl.innerHTML = '<div class="text-center py-10 text-gray-300 border border-dashed rounded-xl"><span class="material-icons text-4xl mb-2">inbox</span><p class="text-sm">기간 내 내역이 없습니다.</p></div>';
      return;
    }
    
    let html = '';
    historyData.forEach(item => {
      const typeClass = item.type === '입고' ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-600';
      const qtySign = item.type === '입고' ? '+' : '-';
      const lotHtml = item.lot ? `<span class="text-[10px] bg-gray-100 text-gray-500 px-1 rounded ml-1">Lot: ${item.lot}</span>` : '';

      html += `
        <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
          <div>
            <div class="text-xs text-gray-400 mb-1">${item.date}</div>
            <div class="font-bold text-gray-800 text-lg flex items-center">
              ${item.item}
              ${lotHtml}
            </div>
            <div class="text-xs text-gray-500">${item.desc || '-'}</div>
          </div>
          <div class="text-right">
            <span class="text-xs font-bold px-2 py-1 rounded ${typeClass} mb-1 inline-block">${item.type}</span>
            <div class="font-bold text-gray-700 text-lg">${qtySign}${item.qty}</div>
          </div>
        </div>`;
    });
    listEl.innerHTML = html;
  }

  function openMaterialDetail(itemName) {
    if (!cachedMaterials || !cachedMaterials.history) return;

    const allHistory = cachedMaterials.history.filter(h => h.item === itemName);
    
    const mainStart = document.getElementById('main-date-start').value;
    const mainEnd = document.getElementById('main-date-end').value;
    
    document.getElementById('detail-date-start').value = mainStart;
    document.getElementById('detail-date-end').value = mainEnd;

    currentDetailContext = {
      item: itemName,
      rawHistory: allHistory,
      selectedLot: 'ALL'
    };

    document.getElementById('detail-title').innerText = itemName;
    updateDetailView();
    openModal('modal-material-detail');
  }

  function updateDetailView() {
    const ctx = currentDetailContext;
    const startStr = document.getElementById('detail-date-start').value;
    const endStr = document.getElementById('detail-date-end').value;
    const hideZero = document.getElementById('toggle-detail-zero').checked;

    const dateFilteredHistory = ctx.rawHistory.filter(h => {
        return h.date >= startStr && h.date <= endStr;
    });

    const lotSummary = {};
    let totalQty = 0;
    
    dateFilteredHistory.forEach(h => {
      const qty = h.type === '입고' ? h.qty : -h.qty;
      totalQty += qty;
      
      const lotKey = h.lot ? h.lot : 'Lot 없음';
      if (!lotSummary[lotKey]) lotSummary[lotKey] = 0;
      lotSummary[lotKey] += qty;
    });

    let finalDisplayList = dateFilteredHistory;
    if (ctx.selectedLot !== 'ALL') {
      finalDisplayList = finalDisplayList.filter(h => (h.lot || 'Lot 없음') === ctx.selectedLot);
    }

    renderDetailLotChips(lotSummary, totalQty, hideZero);
    renderDetailList(finalDisplayList);
  }

  function renderDetailLotChips(lotSummary, totalQty, hideZero) {
    const container = document.getElementById('detail-lot-chips');
    const ctx = currentDetailContext;
    
    const isAllSelected = ctx.selectedLot === 'ALL';
    const allClass = isAllSelected 
      ? 'bg-orange-500 text-white shadow ring-2 ring-orange-200' 
      : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50';

    let html = `
      <button type="button" onclick="filterDetailByLot('ALL')" class="flex-shrink-0 px-4 py-2 rounded-full text-xs font-bold transition-all active:scale-95 ${allClass} flex items-center space-x-2">
          <span>전체</span>
          <span class="bg-black bg-opacity-10 px-1.5 py-0.5 rounded-full text-[10px]">${totalQty}</span>
      </button>
    `;

    Object.keys(lotSummary).forEach(lotKey => {
        const qty = lotSummary[lotKey];
        if (hideZero && qty === 0 && ctx.selectedLot !== lotKey) return;

        const isSelected = ctx.selectedLot === lotKey;
        const chipClass = isSelected 
          ? 'bg-orange-500 text-white shadow ring-2 ring-orange-200' 
          : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50';
        
        html += `
          <button type="button" onclick="filterDetailByLot('${lotKey}')" class="flex-shrink-0 px-4 py-2 rounded-full text-xs font-bold transition-all active:scale-95 ${chipClass} flex items-center space-x-2">
            <span class="truncate max-w-[80px]">${lotKey}</span>
            <span class="bg-black bg-opacity-10 px-1.5 py-0.5 rounded-full text-[10px]">${qty}</span>
          </button>
        `;
    });

    container.innerHTML = html;
  }

  function filterDetailByLot(lotKey) {
    currentDetailContext.selectedLot = lotKey;
    updateDetailView();
  }

  function renderDetailList(displayList) {
    const container = document.getElementById('detail-content');
    
    if (displayList.length === 0) {
      container.innerHTML = '<div class="text-center text-gray-400 py-10">해당 기간에 내역이 없습니다.</div>';
      return;
    }

    let html = '';
    displayList.forEach(item => {
      const isInput = item.type === '입고';
      const qtySign = isInput ? '+' : '-';
      const lotHtml = item.lot ? `<span class="bg-gray-100 text-gray-500 px-1 rounded ml-1 text-[10px]">Lot: ${item.lot}</span>` : '';

      html += `
        <div class="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center shadow-sm">
          <div>
            <div class="text-xs text-gray-400 mb-0.5">${item.date}</div>
            <div class="font-bold text-gray-800 text-sm flex items-center">
                ${item.type}
                ${lotHtml}
            </div>
            <div class="text-xs text-gray-500 mt-0.5">${item.desc || '-'}</div>
          </div>
          <div class="flex items-center space-x-3">
            <div class="text-right mr-2">
              <div class="font-bold text-gray-700 text-lg ${isInput ? 'text-blue-600' : 'text-red-600'}">${qtySign}${item.qty}</div>
            </div>
            <div class="flex space-x-1">
                <button onclick="openEditMaterialModal(${item.id})" class="text-gray-400 hover:text-blue-500 p-1 rounded-full hover:bg-blue-50 transition-colors">
                  <span class="material-icons text-lg">edit</span>
                </button>
                <button onclick="deleteRawMaterial(${item.id})" class="text-gray-400 hover:text-red-500 p-1 rounded-full hover:bg-red-50 transition-colors">
                  <span class="material-icons text-lg">delete</span>
                </button>
            </div>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }

  // [중요] 원재료 등록 폼 제출 (화면 하얗게 되는 문제 방지)
  function submitMaterial(e) {
    e.preventDefault(); 
    
    try {
        const btn = document.getElementById('btn-save-material');
        const rowIndex = document.getElementById('material-rowIndex').value;
        const serverFuncName = rowIndex ? 'editRawMaterial' : 'addMaterial';
        
        handleFormSubmit(e, btn, serverFuncName, 'modal-material', loadMaterials);
    } catch (err) {
        showError("submitMaterial 에러: " + err.message);
    }
  }

  function submitProduction(e) {
    e.preventDefault(); 
    const btn = document.getElementById('btn-save-production');
    handleFormSubmit(e, btn, 'addProduction', 'modal-production', loadProduction);
  }

  function handleFormSubmit(e, btn, serverFuncName, modalId, reloadFunc) {
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerHTML = '<div class="loader mr-2" style="width:16px;height:16px;border-width:2px;"></div> 저장 중...';

    const form = e.target;
    const formData = {};
    new FormData(form).forEach((value, key) => formData[key] = value);

    google.script.run
      .withSuccessHandler((res) => {
        uiAlert(res, "완료", "check_circle");
        form.reset();
        setInitialDates(); 
        closeModal(modalId);
        reloadFunc(); 
        btn.disabled = false;
        btn.innerText = originalText;
        
        if(serverFuncName.includes('RawMaterial')) {
            closeModal('modal-material-detail');
        }
      })
      .withFailureHandler(err => {
        // [수정] 실패 시 커스텀 모달 띄우고, 디버그 콘솔 로그는 생략
        // 서버에서 전달된 에러 메시지에서 "Error: " 제거
        const cleanMsg = err.message.replace(/^Error:\s*/i, '').replace(/^Exception:\s*/i, '').trim();
        uiAlert(cleanMsg, "오류", "error_outline");
        btn.disabled = false;
        btn.innerText = originalText;
      })
      [serverFuncName](formData);
  }
</script>